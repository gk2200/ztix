<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Event Setup</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>

  <header>
    <h1>ztix</h1>
    <div class="settings-toggle">
      <input type="checkbox" id="settings-cb">
      <label class="settings-icon" for="settings-cb">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="3"/>
          <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/>
        </svg>
      </label>
      <div class="settings-panel">
        <div class="settings-section">
          <h3>Authentication</h3>
          <div class="form-group">
            <label for="pg-client-id">x-pg-client-id</label>
            <input type="text" id="pg-client-id" name="pg_client_id" value="ven_test_e80ba7ef34b24f658da7b4a1022cfd8a">
          </div>
          <div class="form-group">
            <label for="pg-client-secret">x-pg-client-secret</label>
            <input type="password" id="pg-client-secret" name="pg_client_secret" value="rBbYbuaP3Ho6sjaoKrNImVDjhg1rMmrP977S1+Z4quLVrIvj">
          </div>
        </div>
        <div class="settings-section">
          <h3>Member</h3>
          <div class="form-group">
            <label for="member-id">memberId</label>
            <input type="text" id="member-id" name="member_id">
          </div>
        </div>
        <label class="btn-save" for="settings-cb">Save</label>
      </div>
    </div>
  </header>

  <main>
    <p class="step-label">Step 1 of ...</p>
    <h2>Event details</h2>

    <form id="event-form">

      <div class="form-group">
        <label for="event-date">Event date (yyyy-MM-ddTHH:mm:ss.FFFFFFzzz)</label>
        <input type="text" id="event-date" name="event_date" onfocus="if(!this.value)this.value='2026-12-01T00:00:00.000000+00:00'">
      </div>

      <div class="form-group">
        <label for="language">Language</label>
        <div class="select-wrapper">
          <select id="language" name="language">
            <option value="">Select a language</option>
            <option value="en">English</option>
            <option value="de">German</option>
            <option value="fr">French</option>
            <option value="es">Spanish</option>
            <option value="it">Italian</option>
            <option value="pt">Portuguese</option>
            <option value="nl">Dutch</option>
            <option value="pl">Polish</option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label for="currency">Currency</label>
        <div class="select-wrapper">
          <select id="currency" name="currency">
            <option value="">Select a currency</option>
            <option value="EUR">EUR - Euro</option>
            <option value="USD">USD - US Dollar</option>
            <option value="GBP">GBP - British Pound</option>
            <option value="CHF">CHF - Swiss Franc</option>
            <option value="SEK">SEK - Swedish Krona</option>
            <option value="NOK">NOK - Norwegian Krone</option>
            <option value="DKK">DKK - Danish Krone</option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label for="ticket-count">Number of tickets</label>
        <input type="number" id="ticket-count" name="ticket_count" min="1" step="1" placeholder="e.g. 2">
      </div>

      <div class="form-group">
        <label for="ticket-value">Ticket value</label>
        <input type="number" id="ticket-value" name="ticket_value" min="0" step="0.01" placeholder="e.g. 100">
      </div>

    </form>
  </main>

  <footer>
    <span id="error-msg" class="error-msg"></span>
    <div class="tooltip-wrap">
      <svg class="tooltip-icon" id="payload-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"/>
        <line x1="12" y1="8" x2="12" y2="12"/>
        <line x1="12" y1="16" x2="12.01" y2="16"/>
      </svg>
      <pre class="tooltip-box" id="payload-preview"></pre>
    </div>
    <button class="btn-next" type="button" onclick="submitQuote()">Next</button>
  </footer>



  <script>
    async function submitQuote() {
      const btn = document.querySelector('.btn-next');
      const errorMsg = document.getElementById('error-msg');

      const body = {
        currencyCode:         document.getElementById('currency').value,
        eventTravelDateTime:  document.getElementById('event-date').value,
        languageCode:         document.getElementById('language').value,
        member:               document.getElementById('member-id').value,
        returnHtml:           true,
        values: [
          {
            numberOfTickets: Number(document.getElementById('ticket-count').value),
            value:           Number(document.getElementById('ticket-value').value),
          }
        ],
      };

      btn.disabled = true;
      btn.textContent = 'Loading...';
      errorMsg.textContent = '';

      try {
        const res = await fetch('/api/quote', {
          method: 'POST',
          headers: {
            'Content-Type':      'application/json',
            'x-pg-client-id':     document.getElementById('pg-client-id').value,
            'x-pg-client-secret': document.getElementById('pg-client-secret').value,
          },
          body: JSON.stringify(body),
        });

        if (!res.ok) {
          const errBody = await res.json().catch(() => ({}));
          throw new Error(`${res.status}: ${JSON.stringify(errBody)}`);
        }

        const data = await res.json();
        sessionStorage.setItem('quoteResponse', JSON.stringify(data));
        sessionStorage.setItem('quoteRequest', JSON.stringify({
          numberOfTickets: body.values[0].numberOfTickets,
          ticketValue:     body.values[0].value,
          member:          body.member,
        }));
        sessionStorage.setItem('pgClientId',     document.getElementById('pg-client-id').value);
        sessionStorage.setItem('pgClientSecret', document.getElementById('pg-client-secret').value);

        window.location.href = 'payment.html';
      } catch (err) {
        errorMsg.textContent = `Error: ${err.message}`;
        btn.disabled = false;
        btn.textContent = 'Next';
      }
    }
    document.getElementById('payload-icon').addEventListener('mouseenter', function () {
      const body = {
        currencyCode:        document.getElementById('currency').value,
        eventTravelDateTime: document.getElementById('event-date').value,
        languageCode:        document.getElementById('language').value,
        member:              document.getElementById('member-id').value,
        returnHtml:          true,
        values: [{
          numberOfTickets: Number(document.getElementById('ticket-count').value) || null,
          value:           Number(document.getElementById('ticket-value').value) || null,
        }],
      };
      document.getElementById('payload-preview').textContent = JSON.stringify(body, null, 2);
    });
  </script>

</body>
</html>
