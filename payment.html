<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Payment</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>

  <header>
    <h1>ztix</h1>
  </header>

  <main>
    <p class="step-label">Step 2 of ...</p>
    <h2>Payment</h2>

    <div id="quote-summary" class="quote-summary"></div>

    <div id="quote-widget"></div>

    <form id="payment-form">

      <div class="form-row">
        <div class="form-group">
          <label for="first-name">First name</label>
          <input type="text" id="first-name" name="first_name">
        </div>
        <div class="form-group">
          <label for="last-name">Last name</label>
          <input type="text" id="last-name" name="last_name">
        </div>
      </div>

      <div class="form-group">
        <label for="email">Email</label>
        <input type="text" id="email" name="email">
      </div>

      <div class="form-group">
        <label for="card-number">Card number</label>
        <input type="text" id="card-number" name="card_number" placeholder="1234 5678 9012 3456" maxlength="19">
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="expiry">Expiry date</label>
          <input type="text" id="expiry" name="expiry" placeholder="MM/YY" maxlength="5">
        </div>
        <div class="form-group">
          <label for="cvv">CVV</label>
          <input type="text" id="cvv" name="cvv" placeholder="123" maxlength="4">
        </div>
      </div>

    </form>
  </main>

  <footer>
    <button class="btn-back" type="button" onclick="window.location.href='index.html'">Back</button>
    <span id="pay-error" class="error-msg"></span>
    <div class="footer-right">
      <button class="btn-next" type="button" onclick="submitSale()">Pay</button>
      <div class="tooltip-wrap">
        <svg class="tooltip-icon" id="payload-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="10"/>
          <line x1="12" y1="8" x2="12" y2="12"/>
          <line x1="12" y1="16" x2="12.01" y2="16"/>
        </svg>
        <pre class="tooltip-box" id="payload-preview"></pre>
      </div>
    </div>
  </footer>

  <script>
    function randomRef(len) {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      return Array.from({ length: len }, () => chars[Math.floor(Math.random() * chars.length)]).join('');
    }

    function randomPhone() {
      return `+1-555-${String(Math.floor(Math.random() * 900) + 100)}-${String(Math.floor(Math.random() * 9000) + 1000)}`;
    }

    async function submitSale() {
      const btn     = document.querySelector('.btn-next');
      const errMsg  = document.getElementById('pay-error');
      const request = JSON.parse(sessionStorage.getItem('quoteRequest') || '{}');
      const quote   = JSON.parse(sessionStorage.getItem('quoteResponse') || '{}');
      const product = quote.products?.[0];

      const itemValue = (product?.productData?.[0]?.sourcePrice ?? 0) / (request.numberOfTickets ?? 1);
      const items = Array.from({ length: request.numberOfTickets ?? 1 }, (_, i) => ({
        customerName: `${pick(firstNames)} ${pick(lastNames)}`,
        description:  `Item Description ${i + 1}`,
        reference:    `Item Reference ${i + 1}`,
        value:        itemValue,
      }));

      const body = {
        bookingReference: randomRef(8),
        customers: [{
          email:     document.getElementById('email').value,
          firstName: document.getElementById('first-name').value,
          lastName:  document.getElementById('last-name').value,
          telephone: randomPhone(),
        }],
        isPaidInFull: true,
        member:       request.member ?? '',
        products: [{
          productId:   product?.productData?.[0]?.productId,
          productCode: product?.code,
          sold:        productSelection?.sold ?? false,
          items,
        }],
        quoteId: quote.quoteId,
      };

      btn.disabled = true;
      btn.textContent = 'Processing...';
      errMsg.textContent = '';

      try {
        const res = await fetch('/api/sale', {
          method: 'POST',
          headers: {
            'Content-Type':       'application/json',
            'x-pg-client-id':     sessionStorage.getItem('pgClientId') ?? '',
            'x-pg-client-secret': sessionStorage.getItem('pgClientSecret') ?? '',
          },
          body: JSON.stringify(body),
        });

        if (!res.ok) {
          const errBody = await res.json().catch(() => ({}));
          throw new Error(`${res.status}: ${JSON.stringify(errBody)}`);
        }

        const data = await res.json();
        sessionStorage.setItem('saleResponse', JSON.stringify(data));
        sessionStorage.setItem('productSelection', JSON.stringify(productSelection));
        window.location.href = 'confirmation.html';
      } catch (err) {
        errMsg.textContent = `Error: ${err.message}`;
        btn.disabled = false;
        btn.textContent = 'Pay';
      }
    }

    const firstNames = ['James', 'Emma', 'Liam', 'Olivia', 'Noah', 'Sophia', 'Lucas', 'Mia'];
    const lastNames  = ['Taylor', 'Smith', 'Johnson', 'Brown', 'Wilson', 'Davis', 'Clark', 'Lee'];
    const pick = arr => arr[Math.floor(Math.random() * arr.length)];

    const firstName = pick(firstNames);
    const lastName  = pick(lastNames);
    document.getElementById('first-name').value = firstName;
    document.getElementById('last-name').value  = lastName;
    document.getElementById('email').value       = `${firstName.toLowerCase()}.${lastName.toLowerCase()}@example.com`;

    let productSelection = null;

    document.addEventListener('pg-change', function (e) {
      productSelection = e.detail;
      if (typeof updateTotal === 'function') updateTotal(productSelection.sold);
    });

    const raw = sessionStorage.getItem('quoteResponse');
    if (raw) {
      const quote = JSON.parse(raw);
      const product = quote.products?.[0];
      const summary = document.getElementById('quote-summary');

      if (product) {
        const request       = JSON.parse(sessionStorage.getItem('quoteRequest') || '{}');
        const rounding      = quote.priceRounding ?? 2;
        const ticketValue   = request.ticketValue ?? 0;
        const protectPrice  = product.productData?.[0]?.totalProductPrice ?? 0;
        const currency      = product.productData?.[0]?.currencyCode ?? '';

        function updateTotal(sold) {
          const total = sold ? ticketValue + protectPrice : ticketValue;
          document.getElementById('basket-total').textContent = `${currency} ${total.toFixed(rounding)}`;
        }

        summary.innerHTML = `
          <div class="quote-row"><span>Quote ID</span><span>${quote.quoteId}</span></div>
          <div class="quote-row"><span>Product</span><span>${product.code}</span></div>
          <div class="quote-row"><span>Total</span><span id="basket-total">${currency} ${ticketValue.toFixed(rounding)}</span></div>
        `;

        if (product.html) {
          const widget = document.getElementById('quote-widget');
          widget.innerHTML = product.html;

          // Re-run any inline scripts from the widget
          widget.querySelectorAll('script').forEach(oldScript => {
            const newScript = document.createElement('script');
            newScript.textContent = oldScript.textContent;
            oldScript.replaceWith(newScript);
          });
        }
      }
    }
    document.getElementById('payload-icon').addEventListener('mouseenter', function () {
      const request = JSON.parse(sessionStorage.getItem('quoteRequest') || '{}');
      const quote   = JSON.parse(sessionStorage.getItem('quoteResponse') || '{}');
      const product = quote.products?.[0];
      const itemValue = (product?.productData?.[0]?.sourcePrice ?? 0) / (request.numberOfTickets ?? 1);

      const body = {
        bookingReference: '<generated on submit>',
        customers: [{
          email:     document.getElementById('email').value,
          firstName: document.getElementById('first-name').value,
          lastName:  document.getElementById('last-name').value,
          telephone: '<generated on submit>',
        }],
        isPaidInFull: true,
        member:       request.member ?? '',
        products: [{
          productId:   product?.productData?.[0]?.productId,
          productCode: product?.code,
          sold:        productSelection?.sold ?? false,
          items: Array.from({ length: request.numberOfTickets ?? 1 }, (_, i) => ({
            customerName: '<random>',
            description:  `Item Description ${i + 1}`,
            reference:    `Item Reference ${i + 1}`,
            value:        itemValue,
          })),
        }],
        quoteId: quote.quoteId,
      };

      document.getElementById('payload-preview').textContent = JSON.stringify(body, null, 2);
    });
  </script>

</body>
</html>
